# 3-Validator PoA Sequencer Network
#
# Architecture: Users send transactions directly to reth (not sequencer)
#
#   User tx ──► reth mempool ──► sequencer orchestrates ──► Celestia DA
#                 (8545)            (consensus)              (finality)
#
# This docker-compose sets up:
# - 3 reth instances (EVM, mempool, block building)
# - 3 sequencer instances (consensus orchestration)
# - TWO SEPARATE P2P networks (they don't commingle!)
#
# ┌─────────────────────────────────────────────────────────────────┐
# │                    DUAL P2P NETWORK ARCHITECTURE                │
# ├─────────────────────────────────────────────────────────────────┤
# │                                                                 │
# │   CONSENSUS P2P (commonware-p2p)          TX GOSSIP (devp2p)   │
# │   - Block relay                           - Transaction gossip │
# │   - Consensus messages (Simplex)          - Peer discovery     │
# │   - Ports: 26656-26658                    - Ports: 30303-30305 │
# │                                                                 │
# │   validator-0 ◄──────────────────────► reth-0                  │
# │        │                                    │                   │
# │        │ consensus p2p                      │ devp2p/eth        │
# │        │                                    │                   │
# │   validator-1 ◄──────────────────────► reth-1                  │
# │        │                                    │                   │
# │   validator-2 ◄──────────────────────► reth-2                  │
# │                                                                 │
# └─────────────────────────────────────────────────────────────────┘
#
# Key insight: The sequencer has NO mempool. It delegates to reth.
#
# Usage:
#   1. Generate keys:    ./scripts/generate-keys.sh
#   2. Start network:    docker compose up -d
#   3. Connect reth p2p: ./scripts/connect-reth-peers.sh
#   4. Send tx:          cast send --rpc-url http://localhost:8545 ...

services:
  # ============================================
  # Validator 0 (seed=0)
  # ============================================
  validator-0:
    image: rkb:latest
    # build:
    #   context: ..
    #   dockerfile: docker/Dockerfile
    container_name: validator-0
    volumes:
      - ./config/validator-0:/config:ro
      - ./keys/validator-0.key:/keys/validator.key:ro
      - ./keys/celestia-0.key:/keys/celestia.key:ro
      - ./keys/jwt-0.hex:/keys/jwt.hex:ro
      - validator-0-data:/data
    environment:
      - RUST_LOG=info,sequencer=info
    ports:
      - "26656:26656"  # P2P
    networks:
      - sequencer-net
    depends_on:
      reth-0:
        condition: service_started
    command: ["run", "--config", "/config/config.toml"]

  reth-0:
    image: ghcr.io/paradigmxyz/reth:v1.10.1
    container_name: reth-0
    volumes:
      - reth-0-data:/data
      - ./keys/jwt-0.hex:/jwt.hex:ro
      - ./genesis.json:/genesis.json:ro
    ports:
      - "8545:8545"   # JSON-RPC - send transactions here
      - "30303:30303" # P2P - for tx gossip
      - "30303:30303/udp"
    networks:
      - sequencer-net
    command:
      - node
      - --datadir=/data
      - --chain=/genesis.json
      # JSON-RPC for user transactions (enable admin API for peer management)
      - --http
      - --http.addr=0.0.0.0
      - --http.port=8545
      - --http.api=eth,net,web3,admin,txpool
      # Engine API for consensus
      - --authrpc.addr=0.0.0.0
      - --authrpc.port=8551
      - --authrpc.jwtsecret=/jwt.hex
      # P2P networking for tx gossip (SEPARATE from consensus p2p!)
      # This is the devp2p/eth network for transaction propagation
      - --port=30303
      - --discovery.port=30303
      - --discovery.addr=0.0.0.0
      # NAT disabled for docker bridge network
      - --nat=none

  # ============================================
  # Validator 1 (seed=1)
  # ============================================
  validator-1:
    image: rkb:latest
    # build:
    #   context: ..
    #   dockerfile: docker/Dockerfile
    container_name: validator-1
    volumes:
      - ./config/validator-1:/config:ro
      - ./keys/validator-1.key:/keys/validator.key:ro
      - ./keys/celestia-1.key:/keys/celestia.key:ro
      - ./keys/jwt-1.hex:/keys/jwt.hex:ro
      - validator-1-data:/data
    environment:
      - RUST_LOG=info,sequencer=info
    ports:
      - "26657:26656"  # P2P
    networks:
      - sequencer-net
    depends_on:
      reth-1:
        condition: service_started
    command: ["run", "--config", "/config/config.toml"]

  reth-1:
    image: ghcr.io/paradigmxyz/reth:v1.10.1
    container_name: reth-1
    volumes:
      - reth-1-data:/data
      - ./keys/jwt-1.hex:/jwt.hex:ro
      - ./genesis.json:/genesis.json:ro
    ports:
      - "8546:8545"   # JSON-RPC (alternate)
      - "30304:30303" # P2P - for tx gossip
      - "30304:30303/udp"
    networks:
      - sequencer-net
    command:
      - node
      - --datadir=/data
      - --chain=/genesis.json
      # JSON-RPC for user transactions (enable admin API for peer management)
      - --http
      - --http.addr=0.0.0.0
      - --http.port=8545
      - --http.api=eth,net,web3,admin,txpool
      # Engine API for consensus
      - --authrpc.addr=0.0.0.0
      - --authrpc.port=8551
      - --authrpc.jwtsecret=/jwt.hex
      # P2P networking for tx gossip (SEPARATE from consensus p2p!)
      - --port=30303
      - --discovery.port=30303
      - --discovery.addr=0.0.0.0
      - --nat=none

  # ============================================
  # Validator 2 (seed=2)
  # ============================================
  validator-2:
    image: rkb:latest
    # build:
    #   context: ..
    #   dockerfile: docker/Dockerfile
    container_name: validator-2
    volumes:
      - ./config/validator-2:/config:ro
      - ./keys/validator-2.key:/keys/validator.key:ro
      - ./keys/celestia-2.key:/keys/celestia.key:ro
      - ./keys/jwt-2.hex:/keys/jwt.hex:ro
      - validator-2-data:/data
    environment:
      - RUST_LOG=info,sequencer=info
    ports:
      - "26658:26656"  # P2P
    networks:
      - sequencer-net
    depends_on:
      reth-2:
        condition: service_started
    command: ["run", "--config", "/config/config.toml"]

  reth-2:
    image: ghcr.io/paradigmxyz/reth:v1.10.1
    container_name: reth-2
    volumes:
      - reth-2-data:/data
      - ./keys/jwt-2.hex:/jwt.hex:ro
      - ./genesis.json:/genesis.json:ro
    ports:
      - "8547:8545"   # JSON-RPC (alternate)
      - "30305:30303" # P2P - for tx gossip
      - "30305:30303/udp"
    networks:
      - sequencer-net
    command:
      - node
      - --datadir=/data
      - --chain=/genesis.json
      # JSON-RPC for user transactions (enable admin API for peer management)
      - --http
      - --http.addr=0.0.0.0
      - --http.port=8545
      - --http.api=eth,net,web3,admin,txpool
      # Engine API for consensus
      - --authrpc.addr=0.0.0.0
      - --authrpc.port=8551
      - --authrpc.jwtsecret=/jwt.hex
      # P2P networking for tx gossip (SEPARATE from consensus p2p!)
      - --port=30303
      - --discovery.port=30303
      - --discovery.addr=0.0.0.0
      - --nat=none

networks:
  sequencer-net:
    driver: bridge

volumes:
  validator-0-data:
  validator-1-data:
  validator-2-data:
  reth-0-data:
  reth-1-data:
  reth-2-data:
